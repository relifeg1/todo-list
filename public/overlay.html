// âœ… Ø±Ø§Ø¨Ø· nPoint Ø§Ù„Ù…ÙˆØ­Ø¯ (Ù†ÙØ³ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø£Ø¯Ù…Ù†)
const API_URL = "https://api.npoint.io/9ff5d39f969a4b4840ba";

let config = { 
    visibleDuration: 15, hiddenDuration: 300, visibilityMode: 'auto', 
    hideLevel: false, hideXP: false, enableGlitch: true, enableParticles: true, autoLevelUp: true,
    currentLevel: 1, twitchChannel: "", showAAR: false
};

let currentData = { tasks: [], settings: {} };
let justCompletedIds = [];
let justFailedIds = [];
let tasksWithTimer = [];
let activeTimer = null;

function startSystem() {
    // 1. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Ø´Ø©
    const hud = document.querySelector('.hud-wrapper');
    if(hud) {
        hud.style.background = 'transparent';
        hud.style.opacity = '1'; 
        hud.style.transform = 'translateX(0)';
    }

    // 2. Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§ØªØµØ§Ù„ ØµØºÙŠØ±
    const list = document.getElementById('main-list');
    if(list) list.innerHTML = "<li style='color:#4CAF50; font-size:0.8em;'>ğŸ“¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...</li>";

    // 3. Ø§Ù„Ø¨Ø¯Ø¡
    loadData();
    setInterval(loadData, 3000); // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 3 Ø«ÙˆØ§Ù†ÙŠ
    setInterval(updateTimers, 1000);
}

function loadData() {
    var xhr = new XMLHttpRequest();
    // âš ï¸ Ø§Ù„Ø­ÙŠÙ„Ø© Ù‡Ù†Ø§: Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù… Ø¹Ø´ÙˆØ§Ø¦ÙŠ (?t=...) ÙŠØ¬Ø¨Ø± OBS Ø¹Ù„Ù‰ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
    xhr.open("GET", API_URL + "?t=" + Date.now(), true);
    
    xhr.onload = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
            try {
                var jsonResponse = JSON.parse(xhr.responseText);
                processUpdate(jsonResponse);
            } catch (e) { console.error("JSON Error"); }
        }
    };
    xhr.send();
}

function processUpdate(newData) {
    let safeData = { tasks: [], settings: {} };
    if (newData.tasks) safeData = newData;
    else if (Array.isArray(newData)) safeData.tasks = newData;

    if (safeData.settings) config = { ...config, ...safeData.settings };

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± AAR
    const aarScreen = document.getElementById('aarScreen');
    if(aarScreen && config.showAAR) {
        if(!aarScreen.classList.contains('aar-visible')) {
            showAAR(safeData.tasks);
            aarScreen.classList.add('aar-visible');
            document.getElementById('hudContainer').classList.remove('hud-visible'); 
        }
    } else if(aarScreen) {
        aarScreen.classList.remove('aar-visible');
    }

    // Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const tasksChanged = JSON.stringify(safeData.tasks) !== JSON.stringify(currentData.tasks);
    
    // Ø§Ù„Ø£ØµÙˆØ§Øª
    justCompletedIds = []; justFailedIds = [];
    if (currentData.tasks.length > 0) {
        safeData.tasks.forEach(newTask => {
            const oldTask = currentData.tasks.find(t => t.id === newTask.id);
            if (oldTask && !oldTask.done && newTask.done) justCompletedIds.push(newTask.id);
            if (oldTask && !oldTask.failed && newTask.failed) justFailedIds.push(newTask.id);
        });
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ ØªØºÙŠØ±Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (tasksChanged || currentData.tasks.length === 0) {
        updateDom(safeData.tasks || []);
        if(config.visibilityMode === 'always') showHud();
        else if (tasksChanged) showHud();
    }
    currentData = safeData;
}

function updateDom(allTasks) {
    // Ø§Ù„Ù„ÙÙ„ ÙˆØ§Ù„Ø¨Ø§Ø±
    const lvlDisplay = document.getElementById('levelDisplay');
    if(lvlDisplay) {
        lvlDisplay.innerText = "LVL " + (config.currentLevel || 1);
        lvlDisplay.style.display = config.hideLevel ? 'none' : 'block';
    }
    const track = document.getElementById('xpTrack');
    if(track) track.style.display = config.hideXP ? 'none' : 'block';

    // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…
    const currentLvlTasks = allTasks.filter(t => (t.level || 1) == config.currentLevel);
    
    // Ø­Ø³Ø§Ø¨ XP
    let totalPoints = 0, earnedPoints = 0;
    currentLvlTasks.forEach(t => {
        if(t.failed) return; 
        const points = (t.type === 'side') ? 1 : 3;
        totalPoints += points;
        if(t.done) earnedPoints += points;
    });
    const progressPercent = totalPoints === 0 ? 0 : (earnedPoints / totalPoints) * 100;
    const xpBar = document.getElementById('xpBar');
    if(xpBar) {
        xpBar.style.width = `${progressPercent}%`;
        xpBar.style.background = (progressPercent >= 100) ? "#4CAF50" : "linear-gradient(90deg, #ff9800, #ffeb3b)";
    }

    // Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
    const mainList = document.getElementById('main-list');
    const sideList = document.getElementById('side-list');
    const mainSection = document.getElementById('main-section');
    const sideSection = document.getElementById('side-section');

    if(mainList) mainList.innerHTML = ''; 
    if(sideList) sideList.innerHTML = ''; 
    tasksWithTimer = [];
    let counter = 1, hasMain = false, hasSide = false;

    currentLvlTasks.forEach(task => {
        const li = document.createElement('li');
        li.className = task.type === 'side' ? 'task-side' : 'task-main';
        if(task.done) li.classList.add('done');
        if(task.failed) li.classList.add('failed');

        if (justCompletedIds.includes(task.id)) {
            li.classList.add('just-finished');
            if(config.enableParticles) spawnParticles(li);
            playSound('successSound');
        }
        if (justFailedIds.includes(task.id)) {
            li.classList.add('just-failed');
            playSound('failSound');
        }

        const marker = task.type === 'side' ? 'â—‡' : 'â—†'; 
        let timerHtml = task.hasTimer ? `<span id="timer-${task.id}" class="timer-display">00:00</span>` : '';
        if(task.hasTimer) tasksWithTimer.push(task);

        li.innerHTML = `<span class="task-id">[${counter++}]</span><span class="marker">${marker}</span> <span class="text">${task.text}</span>${timerHtml}`;

        if (task.type === 'side') { if(sideList) sideList.appendChild(li); hasSide = true; } 
        else { if(mainList) mainList.appendChild(li); hasMain = true; }
    });

    if(mainSection) mainSection.style.display = hasMain ? 'block' : 'none';
    if(sideSection) sideSection.style.display = hasSide ? 'block' : 'none';
    
    updateTimers();
}

function showHud() {
    const hud = document.getElementById('hudContainer');
    if(hud) {
        if(config.enableGlitch) document.body.classList.add('glitch-active');
        else document.body.classList.remove('glitch-active');
        hud.classList.add('hud-visible');
    }
    if(config.visibilityMode !== 'always') {
        if(activeTimer) clearTimeout(activeTimer);
        activeTimer = setTimeout(hideHud, config.visibleDuration * 1000);
    }
}

function hideHud() {
    if(config.visibilityMode === 'always') return;
    const hud = document.getElementById('hudContainer');
    if(hud) hud.classList.remove('hud-visible');
}

function playSound(id) {
    const audio = document.getElementById(id);
    if(audio) { audio.currentTime = 0; audio.play().catch(()=>{}); }
}

function updateTimers() {
    const now = Date.now();
    tasksWithTimer.forEach(task => {
        const el = document.getElementById(`timer-${task.id}`);
        if(el) {
            let diff = ((task.done||task.failed) ? (task.timerEnd || now) : now) - task.timerStart;
            if(diff < 0) diff = 0;
            const s = Math.floor((diff/1000)%60).toString().padStart(2,'0');
            const m = Math.floor((diff/1000/60)).toString().padStart(2,'0');
            el.innerText = `${m}:${s}`;
        }
    });
}

function spawnParticles(element) {
    const rect = element.getBoundingClientRect();
    const colors = ['#ff9800', '#00bcd4', '#4CAF50', '#ffffff'];
    for (let i = 0; i < 20; i++) {
        const p = document.createElement('div'); p.classList.add('confetti');
        p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        p.style.left = (rect.left + Math.random() * rect.width) + 'px';
        p.style.top = (rect.top + rect.height / 2) + 'px';
        document.body.appendChild(p); setTimeout(() => p.remove(), 2000);
    }
}

function showAAR(allTasks) {
    let done=0, fail=0;
    if(allTasks) allTasks.forEach(t => { if(t.done) done++; if(t.failed) fail++; });
    const sEl = document.getElementById('aarSuccess'); if(sEl) sEl.innerText = done;
    const fEl = document.getElementById('aarFail'); if(fEl) fEl.innerText = fail;
    playSound('reportSound');
}

startSystem();