<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Game HUD - Zairuduo (Animation)</title>
    <link href="https://fonts.googleapis.com/css2?family=Changa:wght@500;700;800&display=swap" rel="stylesheet">
    <script src="https://github.com/tmijs/tmi.js/releases/download/v1.8.5/tmi.min.js"></script>

    <style>
        body { 
            font-family: 'Changa', sans-serif; 
            margin: 0; padding: 25px; 
            background-color: transparent; 
            overflow: hidden; 
            color: white;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .hud-wrapper {
            width: 450px;
            border-right: 3px solid rgba(255, 255, 255, 0.15);
            padding-right: 20px; 
            opacity: 0; 
            transform: translateX(30px);
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1); /* تسريع الظهور قليلاً */
        }

        .hud-visible { opacity: 1; transform: translateX(0); }

        .section-title {
            font-size: 16px; margin-bottom: 8px; margin-top: 20px;
            opacity: 0.9; font-weight: 800; display: flex; align-items: center;
        }
        .title-main { color: #ff9800; text-shadow: 0 0 15px rgba(255, 152, 0, 0.5); }
        .title-side { color: #00bcd4; text-shadow: 0 0 15px rgba(0, 188, 212, 0.5); margin-top: 30px; }

        ul { list-style: none; padding: 0; margin: 0; }
        li {
            display: flex; align-items: center; justify-content: flex-start;
            margin-bottom: 6px; cursor: pointer; position: relative; transition: all 0.3s;
            padding: 5px; border-radius: 4px; /* تحسين الخلفية للأنميشن */
        }
        
        .task-id {
            font-size: 0.6em; color: #aaa; margin-left: 8px; background: rgba(0,0,0,0.6);
            padding: 2px 6px; border-radius: 4px; font-family: 'Segoe UI', sans-serif; letter-spacing: 1px;
        }

        .marker { margin-left: 8px; font-size: 14px; line-height: 0; transition: all 0.3s; }
        
        .task-main { font-size: 26px; font-weight: 700; color: #fff; text-shadow: 2px 2px 0px rgba(0,0,0,0.8); line-height: 1.4; }
        .task-main .marker { color: #ff9800; font-size: 18px; }
        
        .task-side { font-size: 20px; font-weight: 500; color: #e0e0e0; padding-right: 10px; }
        .task-side .marker { color: #00bcd4; }
        
        /* حالة الانتهاء العادية (بعد الأنميشن) */
        li.done { opacity: 0.5; filter: grayscale(100%); }
        li.done span.text { text-decoration: line-through; }
        li.done .marker { color: #4CAF50 !important; transform: scale(1.2); }

        /* =========================================
           أنميشن الإنجاز المبهــر (Flash Effect)
           ========================================= */
        @keyframes mission-complete {
            0% { 
                background-color: rgba(255, 255, 255, 0.8); /* وميض أبيض */
                transform: scale(1.02) translateX(-10px);
                opacity: 1;
                filter: grayscale(0%);
            }
            30% {
                background-color: rgba(255, 215, 0, 0.4); /* ذهبي */
                transform: scale(1.1);
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            }
            100% { 
                background-color: transparent; 
                transform: scale(1);
            }
        }

        /* الكلاس الذي سيتم إضافته للجافاسكربت */
        .just-finished {
            animation: mission-complete 1.5s ease-out forwards;
            z-index: 10; /* ليظهر فوق كل شيء أثناء الوميض */
        }

    </style>
</head>
<body>

<div id="hudContainer" class="hud-wrapper">
    <div id="main-section" style="display:none;">
        <div class="section-title title-main">/// العمليات الرئيسية</div>
        <ul id="main-list"></ul>
    </div>

    <div id="side-section" style="display:none;">
        <div class="section-title title-side">/// أهداف ثانوية</div>
        <ul id="side-list"></ul>
    </div>
</div>

<script>
    const TWITCH_CHANNEL = "zairuduo"; 
    const API_URL = "/api/data";
    
    let visibleDuration = 15;
    let hiddenDuration = 300;
    
    let activeTimer = null;
    let currentData = { tasks: [], settings: {} };
    let displayMap = [];
    
    // مصفوفة لتخزين معرفات المهام التي تم إنهاؤها حديثاً لتشغيل الأنميشن
    let justCompletedIds = [];

    // --- منطق الدورة ---
    function showHud() {
        const hud = document.getElementById('hudContainer');
        hud.classList.add('hud-visible');
        if (activeTimer) clearTimeout(activeTimer);
        activeTimer = setTimeout(() => { hideHud(); }, visibleDuration * 1000);
    }

    function hideHud() {
        const hud = document.getElementById('hudContainer');
        hud.classList.remove('hud-visible');
        if (activeTimer) clearTimeout(activeTimer);
        activeTimer = setTimeout(() => {
            if (currentData.tasks.length > 0) showHud();
        }, hiddenDuration * 1000);
    }

    function triggerManualUpdate() { showHud(); }

    // --- جلب البيانات ---
    async function fetchData() {
        try {
            const res = await fetch(API_URL);
            const rawData = await res.json();
            let newData = { tasks: [], settings: { visibleDuration: 15, hiddenDuration: 300 } };
            
            if (Array.isArray(rawData)) newData.tasks = rawData;
            else if (rawData && rawData.tasks) newData = rawData;

            if (newData.settings) {
                if(newData.settings.visibleDuration) visibleDuration = newData.settings.visibleDuration;
                if(newData.settings.hiddenDuration) hiddenDuration = newData.settings.hiddenDuration;
            }
            processUpdate(newData);
        } catch(e) { console.error(e); }
    }

    function processUpdate(newData) {
        // اكتشاف التغييرات
        const tasksChanged = JSON.stringify(newData.tasks) !== JSON.stringify(currentData.tasks);
        
        // **المنطق الذكي للأنميشن:**
        // نقارن القائمة الجديدة بالقديمة لنعرف ما الذي تحول إلى "Done"
        justCompletedIds = []; // تصفير القائمة
        if (currentData.tasks.length > 0) {
            newData.tasks.forEach(newTask => {
                const oldTask = currentData.tasks.find(t => t.id === newTask.id);
                // إذا كانت موجودة، ولم تكن منتهية، وأصبحت منتهية الآن
                if (oldTask && !oldTask.done && newTask.done) {
                    justCompletedIds.push(newTask.id);
                }
            });
        }

        if (tasksChanged || currentData.tasks.length === 0) {
            updateDom(newData.tasks);
            
            if ((newData.tasks.length > 0 && tasksChanged) || (currentData.tasks.length === 0 && newData.tasks.length > 0)) {
                triggerManualUpdate(); // إظهار القائمة
            }
        }
        currentData = newData;
    }

    function updateDom(tasks) {
        const mainList = document.getElementById('main-list');
        const sideList = document.getElementById('side-list');
        const mainSection = document.getElementById('main-section');
        const sideSection = document.getElementById('side-section');

        mainList.innerHTML = '';
        sideList.innerHTML = '';
        displayMap = []; 

        let counter = 1;
        let hasMain = false;
        let hasSide = false;

        tasks.forEach(task => {
            displayMap.push(task); 
            const taskNumber = counter++;
            const isSide = task.type === 'side';
            
            const li = document.createElement('li');
            li.id = `task-${task.id}`;
            li.className = isSide ? 'task-side' : 'task-main';
            
            // إضافة كلاس الانتهاء
            if (task.done) li.classList.add('done');

            // **تطبيق الأنميشن إذا كانت المهمة انتهت للتو**
            if (justCompletedIds.includes(task.id)) {
                li.classList.add('just-finished');
                // إزالة الأنميشن من المهمة (لكي لا تبقى مشطوبة بالأنميشن للأبد) لكن تبقى مشطوبة بالكلاس done
                // الملاحظة: الـ CSS handles the final state via .done, but just-finished adds the flash
            }

            li.onclick = () => toggleTaskStatus(task);
            const markerChar = isSide ? '◇' : '◆'; 

            li.innerHTML = `
                <span class="task-id">[${taskNumber}]</span>
                <span class="marker">${markerChar}</span>
                <span class="text">${task.text}</span>
            `;

            if (isSide) { sideList.appendChild(li); hasSide = true; } 
            else { mainList.appendChild(li); hasMain = true; }
        });

        mainSection.style.display = hasMain ? 'block' : 'none';
        sideSection.style.display = hasSide ? 'block' : 'none';
    }

    async function toggleTaskStatus(task) {
        // نحدث الواجهة فوراً لسرعة الاستجابة (Optimistic UI update)
        // هذا يسمح للأنميشن بالعمل حتى قبل رد السيرفر
        const taskIndex = currentData.tasks.findIndex(t => t.id === task.id);
        if(taskIndex > -1) {
            // نحاكي التغيير محلياً عشان processUpdate يلتقطه
            // (في الواقع processUpdate سيلتقط الرد من السيرفر، لكن هذا يضمن التزامن)
        }
        
        // إظهار القائمة فوراً
        triggerManualUpdate();

        // إرسال للسيرفر
        const updatedTasks = JSON.parse(JSON.stringify(currentData.tasks));
        const t = updatedTasks.find(t => t.id === task.id);
        if(t) t.done = !t.done;

        // إرسال الطلب
        try {
            await fetch(API_URL, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tasks: updatedTasks, settings: currentData.settings || {} })
            });
        } catch(e) { console.error(e); }
    }

    // ==========================================
    // Twitch Chat
    // ==========================================
    const client = new tmi.Client({ channels: [TWITCH_CHANNEL] });
    client.connect().catch(console.error);
    client.on('message', (channel, tags, message, self) => {
        if (self) return;
        const msg = message.toLowerCase();
        if (msg.startsWith('!done') || msg.startsWith('!تم')) {
            const isMod = tags.mod || tags['user-id'] === tags['room-id'];
            if (isMod) {
                const parts = msg.split(' ');
                if (parts.length > 1) {
                    const num = parseInt(parts[1]);
                    if (!isNaN(num) && num > 0 && num <= displayMap.length) {
                        toggleTaskStatus(displayMap[num - 1]);
                    }
                }
            }
        }
    });

    setInterval(fetchData, 2000);
    fetchData();
</script>

</body>
</html>