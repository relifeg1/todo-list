<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>OBS Dock - nPoint</title>
    <link href="https://fonts.googleapis.com/css2?family=Changa:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Changa', sans-serif; background: #1c1c1c; color: #eee; margin: 0; padding: 10px; font-size: 13px; }
        .row { display: flex; gap: 5px; margin-bottom: 5px; }
        input, select, button { background: #333; border: 1px solid #444; color: white; padding: 6px; border-radius: 4px; font-family: 'Changa'; width: 100%; box-sizing: border-box; }
        .btn-add { background: #ff9800; color: black; font-weight: bold; cursor: pointer; }
        ul { list-style: none; padding: 0; margin: 0; }
        li { background: #252525; padding: 6px; margin-bottom: 4px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; border-right: 3px solid #555; }
        li.done { border-color: #4CAF50; opacity: 0.6; text-decoration: line-through; }
        li.current { border-left: 2px solid #ff9800; }
        .btns { display: flex; gap: 2px; }
        .btns button { width: 24px; padding: 0; }
        #status { font-size: 0.8em; color: #666; text-align: center; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="row"><input type="text" id="tIn" placeholder="مهمة جديدة..."></div>
    <div class="row">
        <select id="tType"><option value="main">رئيسية</option><option value="side">جانبية</option></select>
        <input type="number" id="tLvl" value="1" style="width:50px;">
        <button class="btn-add" onclick="add()">+</button>
    </div>
    <ul id="list"></ul>
    <div id="status">Connecting...</div>

<script>
    // ✅ رابط nPoint
    const API_URL = "https://api.npoint.io/9ff5d39f969a4b4840ba";

    let store = { tasks: [], settings: { currentLevel: 1 }, presets: {} };

    async function load() {
        try {
            const r = await fetch(API_URL);
            const d = await r.json();
            store = { ...store, ...d };
            if(!store.tasks) store.tasks = [];
            draw();
            document.getElementById('status').innerText = "Online";
        } catch(e) { document.getElementById('status').innerText = "Error"; }
    }

    async function push() {
        // تحديث البريسيت (الحفظ التلقائي للألعاب)
        const key = `${store.settings.activeGame || 'Default'}_${store.settings.currentLevel || 1}`;
        store.presets[key] = store.tasks;
        
        await fetch(API_URL, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(store) });
        load();
    }

    function draw() {
        const ul = document.getElementById('list'); ul.innerHTML = "";
        const curLvl = store.settings.currentLevel || 1;
        document.getElementById('tLvl').value = curLvl; // تحديث خانة اللفل تلقائياً

        const sorted = [...store.tasks].sort((a,b) => {
            if(a.level == curLvl && b.level != curLvl) return -1;
            if(a.level != curLvl && b.level == curLvl) return 1;
            return a.level - b.level;
        });

        sorted.forEach((t, idx) => {
            const realIdx = store.tasks.findIndex(x => x.id === t.id);
            const li = document.createElement('li');
            if(t.done) li.classList.add('done');
            if(t.level == curLvl) li.classList.add('current');
            
            li.innerHTML = `<span>${t.text}</span>
                <div class="btns">
                    <button style="background:#4CAF50" onclick="tog(${realIdx},'d')">✔</button>
                    <button style="background:#f44336" onclick="del(${realIdx})">✕</button>
                </div>`;
            ul.appendChild(li);
        });
    }

    function add() {
        const txt = document.getElementById('tIn').value; if(!txt) return;
        store.tasks.push({ 
            id: Date.now(), text: txt, 
            type: document.getElementById('tType').value, 
            level: parseInt(document.getElementById('tLvl').value), 
            done: false, failed: false 
        });
        document.getElementById('tIn').value = "";
        push();
    }

    function tog(i, a) {
        if(a=='d') { store.tasks[i].done = !store.tasks[i].done; store.tasks[i].failed = false; }
        push();
    }
    
    function del(i) { if(confirm('Del?')) { store.tasks.splice(i,1); push(); } }
    
    setInterval(load, 3000); load();
</script>
</body>
</html>