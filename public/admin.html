<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Game Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Changa:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Changa', sans-serif; background: #0f0f0f; color: #eee; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 850px; background: #1a1a1a; padding: 25px; border-radius: 8px; border: 1px solid #333; }
        h2 { text-align: center; color: #ff9800; margin-bottom: 20px; font-weight: 800; }
        
        /* --- Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª (Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨) --- */
        .game-manager {
            background: #111; padding: 15px; border: 1px solid #333; border-radius: 8px; margin-bottom: 25px;
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
        }
        .gm-section { display: flex; flex-direction: column; gap: 10px; }
        .gm-title { color: #888; font-size: 0.9em; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 5px; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ø­Ù‚ÙˆÙ„ */
        input, select { 
            padding: 10px; background: #252525; border: 1px solid #444; color: #fff; 
            border-radius: 4px; font-family: 'Changa'; outline: none; width: 100%; box-sizing: border-box;
        }
        button { 
            padding: 10px; border: none; font-weight: 800; cursor: pointer; border-radius: 4px; 
            font-family: 'Changa'; transition: 0.2s; 
        }
        
        .btn-create { background: #4CAF50; color: white; }
        .btn-create:hover { background: #45a049; }
        
        .btn-load { background: #2196F3; color: white; }
        .btn-delete { background: #f44336; color: white; width: auto; margin-top: 5px;}

        .active-game-badge {
            background: #ff9800; color: black; padding: 5px 10px; border-radius: 4px; 
            font-weight: bold; text-align: center; margin-top: 10px; font-size: 1.1em;
        }

        /* --- Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØªØµÙ…ÙŠÙ… --- */
        .control-panel { background: #252525; padding: 15px; border-radius: 6px; border: 1px solid #444; margin-bottom: 20px; }
        .control-group { margin-bottom: 10px; }
        .input-area { background: #202020; padding: 15px; border-radius: 6px; border-bottom: 3px solid #ff9800; margin-bottom: 20px; }
        .input-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        
        .btn-add { background: #ff9800; color: black; flex-grow: 1; }
        
        ul { list-style: none; padding: 0; }
        li { padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-radius: 6px; background: #2e2e2e; }
        
    </style>
</head>
<body>

<div class="container">
    <h2>ØºØ±ÙØ© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</h2>

    <div class="game-manager">
        <div class="gm-section" style="border-left: 1px solid #333; padding-left: 20px;">
            <div class="gm-title">â• Ø¥Ù†Ø´Ø§Ø¡ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
            <input type="text" id="newGameInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø© (Ù…Ø«Ù„Ø§Ù‹: Valorant)">
            <button class="btn-create" onclick="createNewGame()">Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¨Ø¯Ø¡ Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©</button>
        </div>

        <div class="gm-section">
            <div class="gm-title">ğŸ“‚ ØªØ­Ù…ÙŠÙ„ Ù„Ø¹Ø¨Ø© Ø³Ø§Ø¨Ù‚Ø©</div>
            <select id="gameSelector">
                <option value="">-- Ø§Ø®ØªØ± Ù…Ù„Ù --</option>
            </select>
            <button class="btn-load" onclick="loadSelectedGame()">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</button>
            <button class="btn-delete" onclick="deleteGame()">Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ ğŸ—‘ï¸</button>
        </div>
    </div>

    <div id="activeGameDisplay" class="active-game-badge">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù„Ø¹Ø¨Ø© Ù†Ø´Ø·Ø©</div>

    <div class="control-panel">
        <div style="display:flex; justify-content:space-between; gap:10px;">
            <label><input type="checkbox" id="autoLevelToggle" checked> Ø§Ù†ØªÙ‚Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„ÙÙ„ (Auto Level)</label>
            <label><input type="checkbox" id="visToggle" checked> Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù€ Overlay</label>
        </div>
        <div class="level-control" style="margin-top:10px; background:#000; padding:10px; display:flex; justify-content:space-between; align-items:center;">
            <span style="color:#ffeb3b;">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="displayLvl">1</span></span>
            <div>
                <button onclick="resetLevel(1)" style="background:#555; color:white; padding:5px 10px;">ØªØµÙÙŠØ± Ù„Ù€ 1</button>
                <button onclick="saveCurrentState()" style="background:#ff9800; color:black; padding:5px 10px;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            </div>
        </div>
    </div>

    <div class="input-area">
        <div class="input-row">
            <input type="text" id="taskInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù‡Ù…Ø©..." style="flex-grow: 2;">
            <input type="number" id="taskLevelInput" value="1" style="width:60px; text-align:center;" title="Ø±Ù‚Ù… Ø§Ù„Ù„ÙÙ„">
            <button class="btn-add" onclick="submitTask()">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
    </div>

    <ul id="taskList"></ul>
</div>

<script>
    const API_URL = "/api/data";
    
    // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    let dataStore = { 
        tasks: [], 
        settings: { activeGame: "Default", currentLevel: 1 }, 
        presets: {} // Ù‡Ù†Ø§ ØªØ®Ø²Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨
    };

    // --- Ø£ÙˆÙ„ Ù…Ø§ ÙŠÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ---
    async function init() {
        await loadData();
        updateGameDropdown();
        updateUI();
        render();
    }

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    async function loadData() {
        try {
            const res = await fetch(API_URL);
            const rawData = await res.json();
            
            // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            dataStore.settings = { ...dataStore.settings, ...rawData.settings };
            dataStore.presets = rawData.presets || {};
            
            // Ø¥Ø°Ø§ Ù„Ù… Ù†ÙƒÙ† ÙÙŠ ÙˆØ¶Ø¹ "Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©"ØŒ Ø­Ù…Ù„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            dataStore.tasks = rawData.tasks || [];
            
        } catch(e) { console.error("Error loading data", e); }
    }

    // --- Ù…Ù†Ø·Ù‚ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ (Ø§Ù„Ø¬Ø¯ÙŠØ¯) ---

    // 1. Ø¥Ù†Ø´Ø§Ø¡ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©
    function createNewGame() {
        const name = document.getElementById('newGameInput').value.trim();
        if(!name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹!");

        // Ø­ÙØ¸ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ (Ù„Ù„Ø­Ù…Ø§ÙŠØ©)
        saveCurrentStateToPresets();

        // ØªØµÙÙŠØ± ÙƒÙ„ Ø´ÙŠØ¡ Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        dataStore.tasks = []; // Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©
        dataStore.settings.activeGame = name;
        dataStore.settings.currentLevel = 1;

        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯Ø®Ù„ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø¨Ø±ÙŠØ³ÙŠØªØ³
        const startKey = `${name}_1`; // GameName_Level
        dataStore.presets[startKey] = [];

        alert(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ Ù„Ù€: ${name}`);
        document.getElementById('newGameInput').value = "";
        
        // Ø­ÙØ¸ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù…
        saveToServer();
        updateGameDropdown();
        updateUI();
        render();
    }

    // 2. ØªØ­Ù…ÙŠÙ„ Ù„Ø¹Ø¨Ø© Ù…Ø®ØªØ§Ø±Ø©
    function loadSelectedGame() {
        // Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        const selectedGame = document.getElementById('gameSelector').value;
        if(!selectedGame) return;

        // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹
        saveCurrentStateToPresets();

        if(confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù…Ù„Ù Ù„Ø¹Ø¨Ø© ${selectedGame}ØŸ`)) {
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ Ù„ÙÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø£Ùˆ Ø§Ù„Ù„ÙÙ„ Ø§Ù„Ø£Ø®ÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª ØªØ¹Ù‚ÙŠØ¯Ø§Ù‹ Ø£ÙƒØ«Ø±ØŒ Ù‡Ù†Ø§ Ø³Ù†Ø¨Ø¯Ø£ Ø¨Ù€ 1)
            // ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ØŒ Ø§Ù„Ø£ÙØ¶Ù„ Ø£Ù† Ù†Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø¹Ø¨Ø©
            
            // Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„ÙÙ„ 1 ÙƒØ¨Ø¯Ø§ÙŠØ©ØŒ ÙˆÙ„ÙƒÙ† ÙŠØ¬Ø¨ Ø£Ù† Ù†Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ù„ÙÙ„Ø§Øª
            // Ù„ØªØ¨Ø³ÙŠØ· Ø§Ù„Ø£Ù…Ø±: Ø³Ù†Ø¨Ø­Ø« ÙÙŠ presets Ø¹Ù† Ø£ÙŠ Ø´ÙŠØ¡ ÙŠØ¨Ø¯Ø£ Ø¨Ù€ selectedGame
            
            // Ù‡Ù†Ø§: Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ±ÙŠØ¯ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø§Ù„Ù„ÙÙ„ 1ØŒ Ø£Ùˆ Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ù…Ø§ ØªÙˆÙ‚Ù Ø¹Ù†Ø¯Ù‡
            // Ø³Ù†Ø­Ù…Ù„ Ø§Ù„Ù„ÙÙ„ 1 ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠØŒ ÙˆØ¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ù‡Ø§Ù… Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡ Ø³ØªØ¸Ù‡Ø±
            const key = `${selectedGame}_1`;
            dataStore.tasks = dataStore.presets[key] || [];
            
            dataStore.settings.activeGame = selectedGame;
            dataStore.settings.currentLevel = 1;

            saveToServer();
            updateUI();
            render();
        }
    }

    // 3. Ø­Ø°Ù Ù„Ø¹Ø¨Ø©
    function deleteGame() {
        const selectedGame = document.getElementById('gameSelector').value;
        if(!selectedGame) return alert("Ø§Ø®ØªØ± Ù„Ø¹Ø¨Ø© Ù„Ù„Ø­Ø°Ù");
        
        if(confirm(`Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª ÙˆÙ…Ù‡Ø§Ù… ${selectedGame} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ`)) {
            // Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªÙŠ ØªØ¨Ø¯Ø£ Ø¨Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø©
            Object.keys(dataStore.presets).forEach(key => {
                if(key.startsWith(selectedGame + "_")) {
                    delete dataStore.presets[key];
                }
            });
            
            // Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ù„Ø¹Ø¨Ù‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ù†ØµÙØ± Ø§Ù„Ø´Ø§Ø´Ø©
            if(dataStore.settings.activeGame === selectedGame) {
                dataStore.settings.activeGame = "None";
                dataStore.tasks = [];
            }
            
            saveToServer();
            updateGameDropdown();
            updateUI();
            render();
        }
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¯Ø§Ø¦Ù…Ø© (Presets)
    function saveCurrentStateToPresets() {
        const game = dataStore.settings.activeGame;
        const level = dataStore.settings.currentLevel;
        if(game && game !== "Default" && game !== "None") {
            // ÙŠØ­ÙØ¸ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ù…ÙØªØ§Ø­: GameName_LevelNumber
            const key = `${game}_${level}`;
            dataStore.presets[key] = JSON.parse(JSON.stringify(dataStore.tasks));
        }
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
    function updateGameDropdown() {
        const select = document.getElementById('gameSelector');
        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…Ù„Ù --</option>';
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„ÙØ±ÙŠØ¯Ø©
        const games = new Set();
        Object.keys(dataStore.presets).forEach(key => {
            // Ø§Ù„Ù…ÙØªØ§Ø­ ÙŠÙƒÙˆÙ† Game_1, Game_2 ... Ù†Ø£Ø®Ø° Ø§Ù„Ø§Ø³Ù… ÙÙ‚Ø·
            const name = key.split('_')[0];
            if(name) games.add(name);
        });

        games.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g;
            opt.innerText = g;
            select.appendChild(opt);
        });
    }

    // --- Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù (Ù†ÙØ³ Ø§Ù„Ø³Ø§Ø¨Ù‚) ---

    function updateUI() {
        document.getElementById('activeGameDisplay').innerText = `Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù†Ø´Ø·Ø©: ${dataStore.settings.activeGame || "Ù„Ø§ ÙŠÙˆØ¬Ø¯"}`;
        document.getElementById('displayLvl').innerText = dataStore.settings.currentLevel || 1;
        document.getElementById('taskLevelInput').value = dataStore.settings.currentLevel || 1;
        document.getElementById('autoLevelToggle').checked = dataStore.settings.autoLevelUp;
    }

    function render() {
        const list = document.getElementById('taskList'); list.innerHTML = "";
        dataStore.tasks.forEach((task, idx) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span>[L${task.level}] ${task.text}</span>
                <button onclick="delTask(${idx})" style="color:red;background:none;">âœ•</button>
            `;
            list.appendChild(li);
        });
    }

    function submitTask() {
        const text = document.getElementById('taskInput').value;
        const lvl = parseInt(document.getElementById('taskLevelInput').value);
        if(!text) return;
        
        dataStore.tasks.push({
            text, level: lvl, done: false, type: 'main', id: Date.now()
        });
        
        // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙˆØ±ÙŠ Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        saveCurrentStateToPresets();
        saveToServer();
        
        document.getElementById('taskInput').value = "";
        render();
    }

    function delTask(idx) {
        dataStore.tasks.splice(idx, 1);
        saveCurrentStateToPresets();
        saveToServer();
        render();
    }

    function resetLevel(l) {
        // Ù‚Ø¨Ù„ Ø§Ù„ØªØºÙŠÙŠØ±ØŒ Ù†Ø­ÙØ¸ Ø§Ù„Ù„ÙÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…
        saveCurrentStateToPresets();
        
        dataStore.settings.currentLevel = l;
        
        // Ù†Ø­Ø§ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ù…Ù‡Ø§Ù… Ø§Ù„Ù„ÙÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        const key = `${dataStore.settings.activeGame}_${l}`;
        if(dataStore.presets[key]) {
            dataStore.tasks = dataStore.presets[key];
        } else {
            dataStore.tasks = []; // Ù„ÙÙ„ Ø¬Ø¯ÙŠØ¯ ÙØ§Ø±Øº
        }
        
        saveToServer();
        updateUI();
        render();
    }

    function saveCurrentState() {
        saveCurrentStateToPresets();
        saveToServer();
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù…Ù„Ù Ø§Ù„Ù„Ø¹Ø¨Ø©!");
    }

    async function saveToServer() {
        await fetch(API_URL, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(dataStore)
        });
    }

    init(); // ØªØ´ØºÙŠÙ„
</script>
</body>
</html>